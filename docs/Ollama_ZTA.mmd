sequenceDiagram
    actor C as Client (Browser/CLI)
    actor N as NGINX (Policy Enforcement Point / Reverse Proxy)
    actor P as oauth2-proxy (OIDC/OAuth2)
    actor I as Identity Provider (Entra ID / Okta / Auth0)
    actor F as Prompt/Policy Filter (optional microservice)
    actor O as Ollama (LLM runtime, internal-only)
    actor L as SIEM / Local Logs

    C ->> N : HTTPS request to /api/generate
    N ->> N : Verify TLS handshake + client cert (mTLS), apply WAF/rate-limit/CORS
    alt mTLS missing/invalid
        N ->> C : 401/403 (blocked by TLS policy)
        N ->> L : Log TLS/authn failure + client info (no PII)
    else mTLS valid
        N ->> L : Log access (TLS OK, proceeding to OIDC gate)
    end

    N ->> P : subrequest /oauth2/auth (check session)
    alt No valid session cookie
        P ->> N : 401 Unauthorized (needs sign‑in)
        N ->> C : 302 Redirect → /oauth2/start
        C ->> P : GET /oauth2/start
        P ->> C : 302 Redirect → I /authorize (PKCE)
        C ->> I : User login + MFA (per policy)
        I ->> C : 302 Redirect → P /oauth2/callback?code=...
        C ->> P : GET /oauth2/callback (code exchange for tokens)
        P ->> C : Set secure session cookie, 302 back to original URL
        C ->> N : Retry original /api/* request (now with session)
        N ->> P : subrequest /oauth2/auth
        P ->> N : 200 OK + X-Auth headers (user, groups, email)
    else Valid session present
        P ->> N : 200 OK + X-Auth headers (user, groups, email)
    end
    N ->> L : Log auth decision + user/group claims (minimized)

    N ->> F : POST /filter (prompt, caller, app metadata)
    alt Policy violation (e.g., PII, jailbreak, over-size, blocked tenant)
        F ->> N : 406/422 with reason code
        N ->> C : 4xx safe error (masked)
    else Allowed
        F ->> N : 200 Allowed
    end

    N ->> O : POST /api/generate (add X-User/X-Groups, strip cookies, set timeouts)
    O ->> N : Streamed tokens / chunked response
    loop while streaming tokens
        N ->> C : Forward token chunks (SSE/HTTP streaming)
    end

    N ->> L : Access + security events (JSON)
    P ->> L : Auth events (login/refresh/logout)
    F ->> L : Policy evaluation results (allow/block, rule id)
    O ->> L : Inference metrics (durations, model id, token counts)

    N ->> C : 200 OK (final chunk) OR controlled 4xx with safe message
